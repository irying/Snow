内容来自梦康老司机的博客及沈剑公众号

#### 业务的解耦使得服务化的出现，多套服务化的出现代码冗余，管理不便最终使得服务治理的出现。



公共user服务

![](https://s9.rr.itc.cn/r/wapChange/20176_8_19/a50onm1669568407619.jpg)



### **微服务架构的两大解耦利器--**配置中心与消息总线(MQ.md)

**放弃 IP 连接服务，选择内网域名**。58 到家是创业公司，痛点和很多公司都很相似。其中一个场景是 IP 的变化。最初，IP 写在配置文件中，通过某个 IP 或端口访问数据与服务。当某台机器出现问题，DB 同事会在新机器做部署，更换 IP。当某个服务或 IP 发生变化，就在配置文件中修改，重启。

这里的经验分享是千万不要用 IP 连接服务或数据库，要选择内网域名。这两者的**区别**在于：

- 使用 IP 连接服务或数据库的方式，所有的库都和一个表有关联，一旦机器挂掉或升高配，几乎所有的业务都需要修改 IP。即便只是升级一个业务，都会严重影响其他业务。
- 选择内网域名的方式后，如果换 IP，在运维层面可以进行统一切断，自动向上链接，上游的业务就不用动，也不受下层变动的影响。



**全局配置**。最开始底层的通用基础服务，配置是写在每个站点；而且每个应用私藏在配置文件里，在升级过程中，不知道谁私藏了这个配置。

面对这两个痛点，58到家采用了下图的解决方案：全局配置。

![](https://s9.rr.itc.cn/r/wapChange/20176_8_19/a3vl6o1669615003619.jpg)

那么，在做扩容的时候，能不能实现调用方不需要升级呢？当然可以，两个小组件就可以实现：

- 监控全局文件的变化情况，**发生变化就进行回调，这样用户中心要配置修改的是全局配置。**
- 动态链接池组件。**这是一个自身及调整流程成本都很低的组件，负载均衡也会在其中实现。**

全局配置对于服务提供方而言，**问题依然没有全部解决，扩容不需要重启，却仍不知道被谁依赖，不知道被谁访问，就没办法做服务治理、限流等操作。**这时，工程师就要引入配置中心，来解决这个问题。



![](https://s9.rr.itc.cn/r/wapChange/20176_8_19/a3ma9v1669646166619.jpg)

配置中心思路是部署用户中心承载所有配置，取代所有全局配置文件。这样一来，所有都依赖配置中心上游，服务1，服务2，服务3，都不再访问global.conf，而是通过配置中心来拉取相关配置**，配置变更，配置中心反向回调，调用方也不要重启。**

![](https://s9.rr.itc.cn/r/wapChange/20176_8_19/a6z3wi1669658672619.jpg)





某一天账号中心集群被 ddos 攻击，被机房直接封 ip 了，而 A 团队和 B 团队都不知道，很多请求都阻塞在了用户的身份鉴权接口的验证上。导致请求越来越多，timeout 时间设置的也比较长，这样网站都越来越卡。

A 团队和 B 团队都吸取了教训，做出了如下方案：

1. 周期性的去对账号中心的服务进行健康，比如一分钟检测一次。
2. **如果发现服务不可用，那么就缓存服务的状态10分钟（unusable），期间继续不停的进行健康巡查，发现服务可用，则修改状态为服可用。**
3. 发现服务不可用的时候，直接抛出异常，不在阻塞等待。
4. 三方都添加了报警，如果服务不可用，都会收到报警。



### 配置中心升级为服务治理

1. 现在系统的代码都被 A/B/C/D 各个团队在用，地址更新了了还要手动更新了，我们能不能做到，服务提供者地址更新了，能推送到所有服务消费者。
2. 之前 A,B 对账号中心的服务做的服务的管理，其实一套通用的方案，能不能搞出来一个平台或者服务（服务治理的雏形），A/B/C/D 都依赖我这个服务（服务治理的雏形），通过这个服务再去管理各个服务。
3. 也就是现在这个服务治理的就是来管理各个服务，目前有两个功能，服务注册、服务订阅、服务的推送。
4. a 服务提供方说，我们过几天要做压测，你们别不能请求我们`192.168.0.10`，你们都请求`192.168.0.11`。哦！也就是**权重，把前者的权重调为0，好，所有的服务提供方都可能会有这种需求。**那么服务治理也承包了。
5. b 服务提供方说，你们写订单的时候调用我们`192.168.0.12`，查订单的时候调我们`192.168.0.13`或者`192.168.0.14`。哦！这不是咱们的读写分离的套路么，行，**我们服务治理加个路由功能，服务提供者只要在动态的配置就行，我们再动态推给消费者**。

### 服务治理

1. 我们服务治理中心，**需要一个注册中心，统计都有哪些人提供了哪些服务，然后消费者，在启动服务的时候，像注册中心发送请求，我们需要哪些服务，注册中心推送提供者的服务信息。**
2. 我们服务治理中心，**需要一个监控中心，统计各个服务提供的次数、服务响应的时间、服务的健康状态。**
3. 服务提供者和服务消费者之间通信，我们就别走 http 了，我们改成自定义协议，自己封装一套rpc 协议才是我们的良药，这样我们就像在使用本地方法一样调用远程的方法了（这个 php 理解可能有点莫名其妙，推荐学习 java，java 是每个老司机绕不过的坎），最好是服务提供者和服务消费者之间使用长连接，减少每次请求连接的时间消耗和网络I/O。这个rpc协议也由我们服务治理还给大家指定吧。

![](https://segmentfault.com/img/bVQ3Wx?w=938&h=470)