http://blog.oldboyedu.com/nginx-waf/



# 一、了解WAF

## 1.1 什么是WAF

Web应用防护系统（也称：网站应用级入侵防御系统 。英文：Web Application Firewall，简称： WAF）。利用国际上公认的一种说法：Web应用 防火墙 是通过执行一系列针对HTTP/HTTPS的 安全策略 来专门为Web应用提供保护的一款产品。

## 1.2 WAF的功能

- 支持IP白名单和黑名单功能，直接将黑名单的IP访问拒绝。
- 支持URL白名单，将不需要过滤的URL进行定义。
- 支持User-Agent的过滤，匹配自定义规则中的条目，然后进行处理（返回403）。
- 支持CC攻击防护，单个URL指定时间的访问次数，超过设定值，直接返回403。
- 支持Cookie过滤，匹配自定义规则中的条目，然后进行处理（返回403）。
- 支持URL过滤，匹配自定义规则中的条目，如果用户请求的URL包含这些，返回403。
- 支持URL参数过滤，原理同上。
- 支持日志记录，将所有拒绝的操作，记录到日志中去



![](http://cdn.oldboyedu.com/wp-content/uploads/2016/02/wpid-c4bb49501a5952282fddb53494b513de_67P_257WGB1_609_7DQ_SN_5BG239_O.png)

## 1.3WAF与网络防火墙的区别

　　网络防火墙作为访问控制设备，**主要工作在OSI模型三、四层**，基于IP报文进行检测。只是对端口做限制，对TCP协议做封堵。其产品设计无需理解HTTP会话，也就决定了无法理解Web应用程序语言如HTML、SQL语言。因此，它不可能对HTTP通讯进行输入验证或攻击规则分析。针对Web网站的恶意攻击绝大部分都将封装为HTTP请求，从80或443端口顺利通过防火墙检测。 
　　一些定位比较综合、提供丰富功能的防火墙，也具备一定程度的应用层防御能力，如能根据TCP会话异常性及攻击特征阻止网络层的攻击，通过IP分拆和组合也能判断是否有攻击隐藏在多个数据包中，但从根本上说他仍然无法理解HTTP会话，难以应对如SQL注入、跨站脚本、cookie窃取、网页篡改等应用层攻击。 
　　web应用防火墙能在应用层理解分析HTTP会话，因此能有效的防止各类应用层攻击，同时他向下兼容，具备网络防火墙的功能。





# 二、使用nginx配置简单实现403和404

```
set $block_user_agent 0;
if ( $http_user_agent ~ "Wget|AgentBench"){
	set $block_user_agent 1;
}
if ($block_user_agent = 1) {
	return 403 ;
}
```



# 三、深入实现WAF

## 3.1 WAF实现规划

分析步骤如下：解析HTTP请求==》匹配规则==》防御动作==》记录日志 
具体实现如下：

- 解析http请求：协议解析模块
- 匹配规则：规则检测模块，匹配规则库
- 防御动作：return 403 或者跳转到自定义界面
- 日志记录：记录到elk中，画出饼图，建议使用json格式 

**书写书序：先检查白名单，通过即不检测；再检查黑名单，不通过即拒绝，检查UA，UA不通过即拒绝；检查cookie；URL检查;URL参数检查，post检查；**

# 四、防cc攻击利器之httpgrard

## 4.1 httpgrard介绍

HttpGuard是基于openresty,以lua脚本语言开发的防cc攻击软件。而openresty是集成了高性能web服务器Nginx，以及一系列的Nginx模块，这其中最重要的，也是我们主要用到的nginx lua模块。HttpGuard基于nginx lua开发，继承了nginx高并发，高性能的特点，可以以非常小的性能损耗来防范大规模的cc攻击。

# 4.2 httpgrard防cc特效

- 限制访客在一定时间内的请求次数
- 向访客发送302转向响应头来识别恶意用户,并阻止其再次访问
- 向访客发送带有跳转功能的js代码来识别恶意用户，并阻止其再次访问
- 向访客发送cookie来识别恶意用户,并阻止其再次访问
- 支持向访客发送带有验证码的页面，来进一步识别，以免误伤
- 支持直接断开恶意访客的连接
- 支持结合iptables来阻止恶意访客再次连接
- 支持白名单功能
- 支持根据统计特定端口的连接数来自动开启或关闭防cc模式 
  详见[github地址](https://github.com/centos-bz/HttpGuard)，在后续的博文中会加入此功能

# 五、WAF上线

- 初期上线只记录日志，不开启WAF，防止误杀
- WAF规则管理使用saltstack工具
- 要知道并不是有了WAF就安全，存在人为因素